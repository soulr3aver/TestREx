from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from pyvirtualdisplay import Display

class SeleniumWrapper():

    def __init__(self, browser_visible):
        if (not browser_visible):
            try:
                self.display = Display(visible=0, size=(800, 600))
                self.display.start()
            except Exception as ex:
                print('ERROR: %s' % ex)

    def __del__(self):
        if hasattr(self, "display"):
            self.display.stop()

    def set_logger(self, logger):
        self.logger = logger

    def open_browser(self):
        self.logger.debug("Getting the browser instance...")
        self.driver = webdriver.Firefox()

    def kill_browser(self):
        if (hasattr(self, "driver")):
            self.logger.debug("Disposing the browser instance...")
            self.driver.close()

    def navigate(self, link):
        self.logger.debug("Navigating to \"%s\"...", link)
        try:
            self.driver.get(link)
            self.logger.debug("...Success!")
        except Exception as error:
            self.logger.info("ERROR: unable to reach \"%s\"" % link)
            self.logger.debug(error)

    def page_source(self):
        self.logger.debug("Retrieving page source...")
        page_src = self.driver.page_source
        self.logger.debug("...Success!")
        return page_src


    def catch_alert(self):
        self.logger.debug("Catching the alert box...")
        return self.driver.switch_to_alert()

    def handle_alert(self):
        self.logger.debug("Catching the alert box...")
        alert = self.driver.switch_to_alert()
        text = alert.text
        self.logger.debug("Alert text: '%s'" % text)
        alert.dismiss()
        self.logger.debug("...alert dismissed!")
        return text

    def execute_js(self, script):
        self.logger.debug("Executing script '%s'" % script)
        self.driver.execute_script(script)


    def lookup_wait(self, identifier, selector, wait):
        try:
            self.logger.debug("Searching for element '%s' by %s...", identifier, selector)
            element = WebDriverWait(self.driver, wait).until(EC.presence_of_element_located((selector, identifier)))
            self.logger.debug("...Success!")
            return element
        except Exception as error:
            self.logger.info("ERROR: Unable to locate the element!")
            self.logger.debug(error)
            raise Exception("Element is not found!")


    def find_xpath(self, identifier, wait=0):
        element = self.lookup_wait(identifier, By.XPATH, wait)
        if (element):
            return ElementWrapper(element)

    def find_name(self, identifier, wait=0):
        element = self.lookup_wait(identifier, By.NAME, wait)
        if (element):
            return ElementWrapper(element)

    def find(self, identifier, wait=0):
        selectors = (By.ID, By.NAME, By.TAG_NAME, By.CLASS_NAME, By.CSS_SELECTOR, By.LINK_TEXT, By.PARTIAL_LINK_TEXT, By.XPATH)
        for selector in selectors:
            try:
                element = self.lookup_wait(identifier, selector, wait)
                if (element):
                    return ElementWrapper(element)
            except:
                continue
        raise Exception("Element is not found!")


    def implicit_wait(self, seconds=1):
        self.logger.debug("Waiting...")
        self.driver.implicitly_wait(seconds)
        self.logger.debug("... end of implicit wait.")

class ElementWrapper():
    def __init__(self, element):
        self.raw = element

    def click(self):
        self.raw.click()

    def keys(self, string):
        self.raw.send_keys(string)

    def clear(self):
        self.raw.clear()

    def is_enabled(self):
        return self.raw.is_enabled()
